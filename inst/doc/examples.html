<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-03-08 Wed 10:42 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Examples for the microsimulation package</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Mark Clements" />
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Examples for the microsimulation package</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgdd7d6a3">1. Introduction</a></li>
<li><a href="#org0ea05ed">2. Tick-tock model</a>
<ul>
<li><a href="#org7e138c0">2.1. R version</a></li>
<li><a href="#org3e3485e">2.2. C++ version</a></li>
</ul>
</li>
<li><a href="#org4004928">3. Illness-death model with costs and QALYs</a>
<ul>
<li><a href="#org745b6f4">3.1. R version</a></li>
<li><a href="#orgd085a2e">3.2. C++ version</a></li>
<li><a href="#org1c89e14">3.3. Benchmark comparing R and C++</a></li>
</ul>
</li>
<li><a href="#orgba574ca">4. Reporting using a data-frame</a>
<ul>
<li><a href="#org57a6d4b">4.1. R version</a></li>
<li><a href="#org90596ce">4.2. C++ version</a></li>
<li><a href="#org5d49dcc">4.3. Benchmark comparing R and C++</a></li>
<li><a href="#org846146a">4.4. C++ using an EventReport</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgdd7d6a3" class="outline-2">
<h2 id="orgdd7d6a3"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>Some examples in both R and C++.</li>
</ul>
</div>
</div>


<div id="outline-container-org0ea05ed" class="outline-2">
<h2 id="org0ea05ed"><span class="section-number-2">2</span> Tick-tock model</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>This simple model includes three states and three transitions:</li>
</ul>


<div class="figure">
<p><img src="tick_tock.png" alt="tick_tock.png" />
</p>
</div>
</div>


<div id="outline-container-org7e138c0" class="outline-3">
<h3 id="org7e138c0"><span class="section-number-3">2.1</span> R version</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>In this implementation, we model only for the events, where the states are implied by the transitions. Note that there are no simulation attributes.</li>
<li>Initially, a message is printed, and <code>"tick"</code> and <code>"stop"</code> events are scheduled.</li>
<li>For each message or event:
<ul class="org-ul">
<li>A description of the event is printed</li>
<li>The response is defined in terms of <code>"tick"</code> &rarr; <code>"tock"</code>, <code>"tock"</code> &rarr; <code>"tick"</code> and <code>"stop"</code> &rarr; <code>clear()</code>.</li>
</ul></li>
<li>Finally, we print a message and return the final time.</li>
<li>To run this, we set the seed, get a new class instance, and <code>run()</code> the class twice.</li>
</ul>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #008b8b;">library</span>(microsimulation, quietly=<span style="color: #228b22;">TRUE</span>)
tick_tock =
    setRefClass(<span style="color: #8b2252;">"tick_tock"</span>,
                contains=<span style="color: #8b2252;">"BaseDiscreteEventSimulation"</span>,
                methods=list(
                    init = \() {
                        cat(<span style="color: #8b2252;">"Started\n"</span>)
                        scheduleAt(rexp(1,1), <span style="color: #8b2252;">"tick"</span>)
                        scheduleAt(rexp(1,0.1), <span style="color: #8b2252;">"stop"</span>)
                    },
                    handleMessage = \(msg) {
                        cat(sprintf(<span style="color: #8b2252;">"Time: %f; event: %s\n"</span>, now(), msg))
                        <span style="color: #a020f0;">switch</span>(msg, 
                               tick=scheduleAt(now()+rexp(1), <span style="color: #8b2252;">"tock"</span>),
                               tock=scheduleAt(now()+rexp(1), <span style="color: #8b2252;">"tick"</span>),
                               clear())
                    },
                    final = \() {cat(<span style="color: #8b2252;">"Finished\n"</span>); now()} ))
set.seed(12345)
sim = new(<span style="color: #8b2252;">"tick_tock"</span>)
replicate(2, sim$run())
</pre>
</div>

<pre class="example">

Attaching package: ‘microsimulation’

The following object is masked from ‘package:Rcpp’:

    LdFlags
Started
Time: 0.441808; event: tick
Time: 1.250275; event: tock
Time: 1.268724; event: tick
Time: 1.724134; event: tock
Time: 1.748072; event: tick
Time: 5.274728; event: stop
Finished
Started
Time: 1.257961; event: tick
Time: 3.075964; event: tock
Time: 3.302451; event: tick
Time: 3.749214; event: tock
Time: 5.001675; event: tick
Time: 5.398762; event: tock
Time: 5.486878; event: tick
Time: 7.209042; event: tock
Time: 9.621881; event: stop
Finished
[1] 5.274728 9.621881
</pre>
</div>
</div>

<div id="outline-container-org3e3485e" class="outline-3">
<h3 id="org3e3485e"><span class="section-number-3">2.2</span> C++ version</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>For the C++ code, we first show that the Rcpp and C++ code depends on the <code>microsimulation</code> package.</li>
<li>For brevity, we use the <code>ssim</code> namespace.</li>
<li>We define a class <code>tick_tock</code> that inherits from the <code>cProcess</code> class.</li>
<li>We define a class field for the <code>finish_time</code>.</li>
<li>We initialise the simulation using the <code>init()</code> function. In this case, we print out a message and schedule the <code>"tick"</code> and <code>"stop"</code> events.</li>
<li>We handle each message or event by (a) printing a message for the event and (b) then schedule other events depending on the message <code>name</code>, which is a <code>std::string</code>.</li>
<li>At the end of the process, we call the <code>stop()</code> method, which copies the final time to <code>finish_time</code> and print a message.</li>
<li>We export the <code>call_tick_tock</code> function from C++ to C for calling from R. This function defines the <code>sim</code> process as an instance of <code>tick_tock</code>, inserts the process into the simulation using <code>create_process</code>, runs the simulation, clears the simulation queue, and returns <code>finish_time</code>.</li>
<li>In R, we compile the function using the <code>sourceCpp</code> function, set the random seed, and call <code>call_tick_tock</code> function twice.</li>
<li>The C++ model has the same output as the R version.</li>
</ul>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #008b8b;">library</span>(microsimulation, quietly=<span style="color: #228b22;">TRUE</span>)
sourceCpp(code=<span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">  // [[Rcpp::depends(microsimulation)]]</span>
<span style="color: #8b2252;">  #include &lt;microsimulation.h&gt;</span>
<span style="color: #8b2252;">  using namespace ssim;</span>
<span style="color: #8b2252;">  // define a process</span>
<span style="color: #8b2252;">  class tick_tock : public cProcess</span>
<span style="color: #8b2252;">  {</span>
<span style="color: #8b2252;">  public:</span>
<span style="color: #8b2252;">    double finish_time;</span>
<span style="color: #8b2252;">    // initialise the simulation</span>
<span style="color: #8b2252;">    void init() {</span>
<span style="color: #8b2252;">      Rprintf(\"Started\\n\");</span>
<span style="color: #8b2252;">      scheduleAt(R::rexp(1.0), \"tick\");</span>
<span style="color: #8b2252;">      scheduleAt(R::rexp(10.0), \"stop\");</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">    // handle the messages</span>
<span style="color: #8b2252;">    void handleMessage(const cMessage* msg) {</span>
<span style="color: #8b2252;">      Rprintf(\"Time: %f; event: %s\\n\", now(), msg-&gt;name.c_str());</span>
<span style="color: #8b2252;">      msg-&gt;name == \"tick\" ? scheduleAt(now()+R::rexp(1.0), \"tock\") :</span>
<span style="color: #8b2252;">        msg-&gt;name == \"tock\" ? scheduleAt(now()+R::rexp(1.0), \"tick\") :</span>
<span style="color: #8b2252;">        Sim::stop_process();</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">    void stop() {</span>
<span style="color: #8b2252;">      finish_time = now();</span>
<span style="color: #8b2252;">      Rprintf(\"Finished\\n\");</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">  };</span>
<span style="color: #8b2252;">  // Exported function: Run the simulation once and return the finish time</span>
<span style="color: #8b2252;">  // [[Rcpp::export]]</span>
<span style="color: #8b2252;">  double call_tick_tock() {</span>
<span style="color: #8b2252;">    tick_tock sim;</span>
<span style="color: #8b2252;">    Sim::create_process(&amp;sim);</span>
<span style="color: #8b2252;">    Sim::run_simulation();</span>
<span style="color: #8b2252;">    Sim::clear();</span>
<span style="color: #8b2252;">    return sim.finish_time;</span>
<span style="color: #8b2252;">  }"</span>)
set.seed(12345)
replicate(2, call_tick_tock())
</pre>
</div>

<pre class="example">
Started
Time: 0.441808; event: tick
Time: 1.250275; event: tock
Time: 1.268724; event: tick
Time: 1.724134; event: tock
Time: 1.748072; event: tick
Time: 5.274728; event: stop
Finished
Started
Time: 1.257961; event: tick
Time: 3.075964; event: tock
Time: 3.302451; event: tick
Time: 3.749214; event: tock
Time: 5.001675; event: tick
Time: 5.398762; event: tock
Time: 5.486878; event: tick
Time: 7.209042; event: tock
Time: 9.621881; event: stop
Finished
[1] 5.274728 9.621881
</pre>
</div>
</div>
</div>


<div id="outline-container-org4004928" class="outline-2">
<h2 id="org4004928"><span class="section-number-2">3</span> Illness-death model with costs and QALYs</h2>
<div class="outline-text-2" id="text-3">

<div class="figure">
<p><img src="illness_death.png" alt="illness_death.png" />
</p>
</div>
</div>

<div id="outline-container-org745b6f4" class="outline-3">
<h3 id="org745b6f4"><span class="section-number-3">3.1</span> R version</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #008b8b;">library</span>(microsimulation, quietly=<span style="color: #228b22;">TRUE</span>)
illness_death =
    setRefClass(<span style="color: #8b2252;">"illness_death"</span>,
                contains=<span style="color: #8b2252;">"BaseDiscreteEventSimulation"</span>,
                fields=list(utility=<span style="color: #8b2252;">"numeric"</span>, QALY=<span style="color: #8b2252;">"numeric"</span>,
                            cost=<span style="color: #8b2252;">"numeric"</span>, cumulative_costs=<span style="color: #8b2252;">"numeric"</span>,
                            debug=<span style="color: #8b2252;">"logical"</span>),
                methods=list(
                    initialize = \(debug=<span style="color: #228b22;">TRUE</span>) {debug <span style="color: #008b8b;">&lt;&lt;-</span> debug},
                    init = \() {
                        <span style="color: #a020f0;">if</span> (debug) cat(<span style="color: #8b2252;">"Individual:\n"</span>)
                        cumulative_costs <span style="color: #008b8b;">&lt;&lt;-</span> QALY <span style="color: #008b8b;">&lt;&lt;-</span> 0.0
                        toHealthy()
                    },
                    toHealthy = \() {
                        utility <span style="color: #008b8b;">&lt;&lt;-</span> 0.95
                        cost <span style="color: #008b8b;">&lt;&lt;-</span> 1000
                        scheduleAt(now()+rexp(1,1/30.0), <span style="color: #8b2252;">"onset"</span>)
                        scheduleAt(now()+rexp(1,1/60.0), <span style="color: #8b2252;">"death"</span>)
                    },
                    toIllness = \() {
                        utility <span style="color: #008b8b;">&lt;&lt;-</span> 0.95*0.8
                        cost <span style="color: #008b8b;">&lt;&lt;-</span> 10000
                        scheduleAt(now()+rexp(1,1/5.0), <span style="color: #8b2252;">"recovered"</span>)
                        scheduleAt(now()+rexp(1,1/10.0), <span style="color: #8b2252;">"death"</span>)
                    },
                    handleMessage = \(msg) {
                        <span style="color: #a020f0;">if</span> (debug) cat(sprintf(<span style="color: #8b2252;">"Time: %f; event: %s\n"</span>, now(), msg))
                        QALY <span style="color: #008b8b;">&lt;&lt;-</span> QALY + discountedInterval(utility, previous(), now(), 0.03)
                        cumulative_costs <span style="color: #008b8b;">&lt;&lt;-</span> cumulative_costs +
                            discountedInterval(cost, previous(), now(), 0.03)
                        clear()
                        <span style="color: #a020f0;">if</span> (msg == <span style="color: #8b2252;">"onset"</span>)
                            toHealthy()
                        <span style="color: #a020f0;">else</span> <span style="color: #a020f0;">if</span> (msg == <span style="color: #8b2252;">"recovered"</span>)
                            toIllness()
                        <span style="color: #a020f0;">else</span>
                            clear()
                    }))
set.seed(12345)
sim = new(<span style="color: #8b2252;">"illness_death"</span>)
replicate(5, {sim$run(); c(sim$QALY, sim$cumulative_costs)}) |&gt;
    t() |&gt; data.frame() |&gt; <span style="color: #8b2252;">"names&lt;-"</span>(c(<span style="color: #8b2252;">"QALY"</span>,<span style="color: #8b2252;">"cumulative_cost"</span>))
</pre>
</div>

<pre class="example">
Individual:
Time: 13.254234; event: onset
Time: 14.361154; event: death
Individual:
Time: 1.436288; event: death
Individual:
Time: 75.477631; event: death
Individual:
Time: 28.865643; event: onset
Time: 35.660268; event: onset
Time: 59.485505; event: death
Individual:
Time: 2.643472; event: onset
Time: 115.923108; event: death
       QALY cumulative_cost
1 11.117066       11702.175
2  1.335915        1406.227
3 28.686987       30196.829
4 26.600625       28000.658
5 31.094833       32731.403
</pre>
</div>
</div>

<div id="outline-container-orgd085a2e" class="outline-3">
<h3 id="orgd085a2e"><span class="section-number-3">3.2</span> C++ version</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #008b8b;">library</span>(microsimulation, quietly=<span style="color: #228b22;">TRUE</span>)
sourceCpp(code=<span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">  // [[Rcpp::depends(microsimulation)]]</span>
<span style="color: #8b2252;">  #include &lt;microsimulation.h&gt;</span>
<span style="color: #8b2252;">  using namespace ssim;</span>
<span style="color: #8b2252;">  // define a process</span>
<span style="color: #8b2252;">  class illness_death : public cProcess</span>
<span style="color: #8b2252;">  {</span>
<span style="color: #8b2252;">  public:</span>
<span style="color: #8b2252;">    double QALY, utility, cumulative_costs, cost;</span>
<span style="color: #8b2252;">    bool debug;</span>
<span style="color: #8b2252;">    std::map&lt;std::string,std::vector&lt;double&gt;&gt; report;</span>
<span style="color: #8b2252;">    // initialise the simulation</span>
<span style="color: #8b2252;">    void init() {</span>
<span style="color: #8b2252;">      if (debug) Rprintf(\"Individual:\\n\");</span>
<span style="color: #8b2252;">      cumulative_costs = QALY = 0.0;</span>
<span style="color: #8b2252;">      this-&gt;toHealthy();</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">    void toHealthy() {</span>
<span style="color: #8b2252;">      utility = 0.95;</span>
<span style="color: #8b2252;">      cost = 1000.0;</span>
<span style="color: #8b2252;">      this-&gt;scheduleAt(now()+R::rexp(30.0), \"onset\");</span>
<span style="color: #8b2252;">      this-&gt;scheduleAt(now()+R::rexp(60.0), \"death\");</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">    void toIllness() {</span>
<span style="color: #8b2252;">      utility = 0.95*0.8;</span>
<span style="color: #8b2252;">      cost = 10000.0;</span>
<span style="color: #8b2252;">      this-&gt;scheduleAt(now()+R::rexp(5.0), \"recovered\");</span>
<span style="color: #8b2252;">      this-&gt;scheduleAt(now()+R::rexp(10.0), \"death\");</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">    // handle the messages</span>
<span style="color: #8b2252;">    void handleMessage(const cMessage* msg) {</span>
<span style="color: #8b2252;">      if (debug) Rprintf(\"Time: %f; event: %s\\n\", now(), msg-&gt;name.c_str());</span>
<span style="color: #8b2252;">      QALY += discountedInterval(utility, previous(), now(), 0.03);</span>
<span style="color: #8b2252;">      cumulative_costs += discountedInterval(cost, previous(), now(), 0.03);</span>
<span style="color: #8b2252;">      this-&gt;cancel_events(); // in this case, we cancel all of the competing events</span>
<span style="color: #8b2252;">      if (msg-&gt;name == \"onset\")</span>
<span style="color: #8b2252;">        toHealthy();</span>
<span style="color: #8b2252;">      else if (msg-&gt;name == \"recovered\")</span>
<span style="color: #8b2252;">        toIllness();</span>
<span style="color: #8b2252;">      else</span>
<span style="color: #8b2252;">        Sim::stop_process();</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">    void stop() {</span>
<span style="color: #8b2252;">      report[\"QALY\"].push_back(QALY);</span>
<span style="color: #8b2252;">      report[\"cumulative_costs\"].push_back(cumulative_costs);</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">  };</span>
<span style="color: #8b2252;">  // Exported function: Run the simulation once</span>
<span style="color: #8b2252;">  // [[Rcpp::export]]</span>
<span style="color: #8b2252;">  Rcpp::DataFrame call_illness_death(int n = 5, bool debug = true) {</span>
<span style="color: #8b2252;">    illness_death sim;</span>
<span style="color: #8b2252;">    sim.debug = debug;</span>
<span style="color: #8b2252;">    for (int i=0; i&lt;n; i++) {</span>
<span style="color: #8b2252;">      Sim::create_process(&amp;sim);</span>
<span style="color: #8b2252;">      Sim::run_simulation();</span>
<span style="color: #8b2252;">      Sim::clear();</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">    return wrap(sim.report);</span>
<span style="color: #8b2252;">  }"</span>)
set.seed(12345)
call_illness_death()
</pre>
</div>

<pre class="example">
Individual:
Time: 13.254234; event: onset
Time: 14.361154; event: death
Individual:
Time: 1.436288; event: death
Individual:
Time: 75.477631; event: death
Individual:
Time: 28.865643; event: onset
Time: 35.660268; event: onset
Time: 59.485505; event: death
Individual:
Time: 2.643472; event: onset
Time: 115.923108; event: death
       QALY cumulative_costs
1 11.117066        11702.175
2  1.335915         1406.227
3 28.686987        30196.829
4 26.600625        28000.658
5 31.094833        32731.403
</pre>
</div>
</div>

<div id="outline-container-org1c89e14" class="outline-3">
<h3 id="org1c89e14"><span class="section-number-3">3.3</span> Benchmark comparing R and C++</h3>
<div class="outline-text-3" id="text-3-3">
<div class="org-src-container">
<pre class="src src-R">microbenchmark::microbenchmark({
    set.seed(12345)
    sim = new(<span style="color: #8b2252;">"illness_death"</span>, debug=<span style="color: #228b22;">FALSE</span>)
    <span style="color: #a020f0;">for</span> (i <span style="color: #a020f0;">in</span> 1:100) sim$run()
}, {
    set.seed(12345)
    call_illness_death(100, debug=<span style="color: #228b22;">FALSE</span>)
},
times=100) |&gt; ascii()
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Unit: microseconds</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-left">expr</th>
<th scope="col" class="org-right">min</th>
<th scope="col" class="org-right">lq</th>
<th scope="col" class="org-right">mean</th>
<th scope="col" class="org-right">median</th>
<th scope="col" class="org-right">uq</th>
<th scope="col" class="org-right">max</th>
<th scope="col" class="org-right">neval</th>
<th scope="col" class="org-left">cld</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">{     set.seed(12345)     sim = new("illness<sub>death</sub>", debug = FALSE)     for (i in 1:100) sim$run() }</td>
<td class="org-right">81610.48</td>
<td class="org-right">85125.80</td>
<td class="org-right">111311.62</td>
<td class="org-right">117356.17</td>
<td class="org-right">132919.92</td>
<td class="org-right">248876.28</td>
<td class="org-right">100.00</td>
<td class="org-left">b</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">{     set.seed(12345)     call<sub>illness</sub><sub>death</sub>(100, debug = FALSE) }</td>
<td class="org-right">426.57</td>
<td class="org-right">544.48</td>
<td class="org-right">655.30</td>
<td class="org-right">690.66</td>
<td class="org-right">809.72</td>
<td class="org-right">859.15</td>
<td class="org-right">100.00</td>
<td class="org-left">a</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>


<div id="outline-container-orgba574ca" class="outline-2">
<h2 id="orgba574ca"><span class="section-number-2">4</span> Reporting using a data-frame</h2>
<div class="outline-text-2" id="text-4">

<div class="figure">
<p><img src="reporting.png" alt="reporting.png" />
</p>
</div>
</div>


<div id="outline-container-org57a6d4b" class="outline-3">
<h3 id="org57a6d4b"><span class="section-number-3">4.1</span> R version</h3>
<div class="outline-text-3" id="text-4-1">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #008b8b;">library</span>(ascii)
<span style="color: #008b8b;">options</span>(asciiType=<span style="color: #8b2252;">"org"</span>)
<span style="color: #008b8b;">library</span>(microsimulation, quietly=<span style="color: #228b22;">TRUE</span>)
simple_person =
  setRefClass(<span style="color: #8b2252;">"simple_person"</span>,
              contains=<span style="color: #8b2252;">"BaseDiscreteEventSimulation"</span>,
              fields=list(id=<span style="color: #8b2252;">"numeric"</span>, state=<span style="color: #8b2252;">"character"</span>, report=<span style="color: #8b2252;">"data.frame"</span>),
              methods=list(
                  initialize = \() {id <span style="color: #008b8b;">&lt;&lt;-</span> -1L},
                  init = \() {
                      id <span style="color: #008b8b;">&lt;&lt;-</span> id + 1L
                      state <span style="color: #008b8b;">&lt;&lt;-</span> <span style="color: #8b2252;">"Healthy"</span>
                      scheduleAt(rweibull(1,8,85), <span style="color: #8b2252;">"toOtherDeath"</span>)
                      scheduleAt(rweibull(1,3,90), <span style="color: #8b2252;">"toCancer"</span>)
                  },
                  handleMessage = \(msg) {
                      report <span style="color: #008b8b;">&lt;&lt;-</span> dplyr::bind_rows(report,
                                           data.frame(id=id, startTime=previous(),
                                                      endTime=now(), state=state, event=msg))
                      <span style="color: #a020f0;">if</span> (msg == <span style="color: #8b2252;">"toCancer"</span>) {
                          state <span style="color: #008b8b;">&lt;&lt;-</span> <span style="color: #8b2252;">"Cancer"</span>
                          <span style="color: #a020f0;">if</span> (runif(1)&lt;0.5)
                              scheduleAt(now()+rweibull(1,2,10), <span style="color: #8b2252;">"toCancerDeath"</span>)
                      } <span style="color: #a020f0;">else</span> clear()
                  }))
set.seed(12345)
sim = new(<span style="color: #8b2252;">"simple_person"</span>)
<span style="color: #a020f0;">for</span> (i <span style="color: #a020f0;">in</span> 1:5) sim$run()
ascii(sim$report)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-right">id</th>
<th scope="col" class="org-right">startTime</th>
<th scope="col" class="org-right">endTime</th>
<th scope="col" class="org-left">state</th>
<th scope="col" class="org-left">event</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-right">0.00</td>
<td class="org-right">0.00</td>
<td class="org-right">45.90</td>
<td class="org-left">Healthy</td>
<td class="org-left">toCancer</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">0.00</td>
<td class="org-right">45.90</td>
<td class="org-right">73.92</td>
<td class="org-left">Cancer</td>
<td class="org-left">toOtherDeath</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">1.00</td>
<td class="org-right">0.00</td>
<td class="org-right">65.27</td>
<td class="org-left">Healthy</td>
<td class="org-left">toOtherDeath</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-right">2.00</td>
<td class="org-right">0.00</td>
<td class="org-right">91.44</td>
<td class="org-left">Healthy</td>
<td class="org-left">toOtherDeath</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-right">3.00</td>
<td class="org-right">0.00</td>
<td class="org-right">61.42</td>
<td class="org-left">Healthy</td>
<td class="org-left">toCancer</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-right">3.00</td>
<td class="org-right">61.42</td>
<td class="org-right">80.92</td>
<td class="org-left">Cancer</td>
<td class="org-left">toOtherDeath</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">4.00</td>
<td class="org-right">0.00</td>
<td class="org-right">98.92</td>
<td class="org-left">Healthy</td>
<td class="org-left">toOtherDeath</td>
</tr>
</tbody>
</table>
</div>
</div>


<div id="outline-container-org90596ce" class="outline-3">
<h3 id="org90596ce"><span class="section-number-3">4.2</span> C++ version</h3>
<div class="outline-text-3" id="text-4-2">
<div class="org-src-container">
<pre class="src src-R">  sourceCpp(code = <span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">  // [[Rcpp::depends(microsimulation)]]</span>
<span style="color: #8b2252;">  #include &lt;microsimulation.h&gt;</span>
<span style="color: #8b2252;">  // utility to make a factor</span>
<span style="color: #8b2252;">  Rcpp::IntegerVector make_factor(std::vector&lt;int&gt; v, Rcpp::CharacterVector levels) {</span>
<span style="color: #8b2252;">    Rcpp::IntegerVector f(v.size());</span>
<span style="color: #8b2252;">    std::transform(v.begin(), v.end(), f.begin(), [](int i) {return 1+i; });</span>
<span style="color: #8b2252;">    f.attr(\"class\") = \"factor\";</span>
<span style="color: #8b2252;">    f.attr(\"levels\") = levels;</span>
<span style="color: #8b2252;">    return f;</span>
<span style="color: #8b2252;">  }</span>
<span style="color: #8b2252;">  enum state_t {Healthy,Cancer,Death};</span>
<span style="color: #8b2252;">  enum event_t {toOtherDeath, toCancer, toCancerDeath};</span>
<span style="color: #8b2252;">  class SimplePerson : public ssim::cProcess</span>
<span style="color: #8b2252;">  {</span>
<span style="color: #8b2252;">  public:</span>
<span style="color: #8b2252;">    int id;</span>
<span style="color: #8b2252;">    state_t state;</span>
<span style="color: #8b2252;">    std::vector&lt;double&gt; startTimes, endTimes;</span>
<span style="color: #8b2252;">    std::vector&lt;int&gt; states, events, ids;</span>
<span style="color: #8b2252;">    SimplePerson() : id(-1) {};</span>
<span style="color: #8b2252;">    void handleMessage(const ssim::cMessage*);</span>
<span style="color: #8b2252;">    void init();</span>
<span style="color: #8b2252;">  };</span>
<span style="color: #8b2252;">  /**</span>
<span style="color: #8b2252;">      Initialise a simulation run for an individual</span>
<span style="color: #8b2252;">  */</span>
<span style="color: #8b2252;">  void SimplePerson::init() {</span>
<span style="color: #8b2252;">    id++;</span>
<span style="color: #8b2252;">    state = Healthy;</span>
<span style="color: #8b2252;">    double tm = R::rweibull(8.0,85.0);</span>
<span style="color: #8b2252;">    this-&gt;scheduleAt(tm,toOtherDeath);</span>
<span style="color: #8b2252;">    this-&gt;scheduleAt(R::rweibull(3.0,90.0),toCancer);</span>
<span style="color: #8b2252;">  }</span>
<span style="color: #8b2252;">  /**</span>
<span style="color: #8b2252;">      Handle receiving self-messages</span>
<span style="color: #8b2252;">  */</span>
<span style="color: #8b2252;">  void SimplePerson::handleMessage(const ssim::cMessage* msg) {</span>
<span style="color: #8b2252;">    ids.push_back(id);</span>
<span style="color: #8b2252;">    startTimes.push_back(this-&gt;previous());</span>
<span style="color: #8b2252;">    endTimes.push_back(ssim::now());</span>
<span style="color: #8b2252;">    states.push_back(state);</span>
<span style="color: #8b2252;">    events.push_back(msg-&gt;kind);</span>
<span style="color: #8b2252;">    switch(msg-&gt;kind) {</span>
<span style="color: #8b2252;">    case toOtherDeath:</span>
<span style="color: #8b2252;">    case toCancerDeath:</span>
<span style="color: #8b2252;">      ssim::Sim::stop_process();</span>
<span style="color: #8b2252;">      break;</span>
<span style="color: #8b2252;">    case toCancer:</span>
<span style="color: #8b2252;">      state = Cancer;</span>
<span style="color: #8b2252;">      if (R::runif(0.0,1.0) &lt; 0.5)</span>
<span style="color: #8b2252;">        this-&gt;scheduleAt(ssim::now() + R::rweibull(2.0,10.0), toCancerDeath);</span>
<span style="color: #8b2252;">      break;</span>
<span style="color: #8b2252;">    default:</span>
<span style="color: #8b2252;">      REprintf(\"No valid kind of event\\n\");</span>
<span style="color: #8b2252;">      break;</span>
<span style="color: #8b2252;">    } // switch</span>
<span style="color: #8b2252;">  } // handleMessage()</span>
<span style="color: #8b2252;">  // [[Rcpp::export]]</span>
<span style="color: #8b2252;">  Rcpp::DataFrame callSimplePersonB(int n = 5) {</span>
<span style="color: #8b2252;">    SimplePerson person;</span>
<span style="color: #8b2252;">    for (int i = 0; i &lt; n; i++) {</span>
<span style="color: #8b2252;">      ssim::Sim::create_process(&amp;person);</span>
<span style="color: #8b2252;">      ssim::Sim::run_simulation();</span>
<span style="color: #8b2252;">      ssim::Sim::clear();</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">    Rcpp::DataFrame df;</span>
<span style="color: #8b2252;">    df.push_back(person.ids,\"id\");</span>
<span style="color: #8b2252;">    df.push_back(person.startTimes,\"startTime\");</span>
<span style="color: #8b2252;">    df.push_back(person.endTimes,\"endTime\");</span>
<span style="color: #8b2252;">    df.push_back(make_factor(person.states,{\"Healthy\",\"Ill\",\"Dead\"}), \"state\");</span>
<span style="color: #8b2252;">    df.push_back(make_factor(person.events,{\"toOtherDeath\", \"toCancer\", \"toCancerDeath\"}), </span>
<span style="color: #8b2252;">                 \"event\");</span>
<span style="color: #8b2252;">    return Rcpp::wrap(df);</span>
<span style="color: #8b2252;">  }</span>
<span style="color: #8b2252;">"</span>)
  set.seed(12345)
  callSimplePersonB() |&gt; ascii()
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-right">id</th>
<th scope="col" class="org-right">startTime</th>
<th scope="col" class="org-right">endTime</th>
<th scope="col" class="org-left">state</th>
<th scope="col" class="org-left">event</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-right">0.00</td>
<td class="org-right">0.00</td>
<td class="org-right">45.90</td>
<td class="org-left">Healthy</td>
<td class="org-left">toCancer</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">0.00</td>
<td class="org-right">45.90</td>
<td class="org-right">73.92</td>
<td class="org-left">Ill</td>
<td class="org-left">toOtherDeath</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">1.00</td>
<td class="org-right">0.00</td>
<td class="org-right">65.27</td>
<td class="org-left">Healthy</td>
<td class="org-left">toOtherDeath</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-right">2.00</td>
<td class="org-right">0.00</td>
<td class="org-right">91.44</td>
<td class="org-left">Healthy</td>
<td class="org-left">toOtherDeath</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-right">3.00</td>
<td class="org-right">0.00</td>
<td class="org-right">61.42</td>
<td class="org-left">Healthy</td>
<td class="org-left">toCancer</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-right">3.00</td>
<td class="org-right">61.42</td>
<td class="org-right">80.92</td>
<td class="org-left">Ill</td>
<td class="org-left">toOtherDeath</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">4.00</td>
<td class="org-right">0.00</td>
<td class="org-right">98.92</td>
<td class="org-left">Healthy</td>
<td class="org-left">toOtherDeath</td>
</tr>
</tbody>
</table>
</div>
</div>


<div id="outline-container-org5d49dcc" class="outline-3">
<h3 id="org5d49dcc"><span class="section-number-3">4.3</span> Benchmark comparing R and C++</h3>
<div class="outline-text-3" id="text-4-3">
<div class="org-src-container">
<pre class="src src-R">microbenchmark::microbenchmark({
    set.seed(12345)
    sim = new(<span style="color: #8b2252;">"simple_person"</span>)
    <span style="color: #a020f0;">for</span> (i <span style="color: #a020f0;">in</span> 1:100) sim$run()
}, {
    set.seed(12345)
    callSimplePersonB(100)
},
times=10) |&gt; ascii()
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Unit: milliseconds</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-left">expr</th>
<th scope="col" class="org-right">min</th>
<th scope="col" class="org-right">lq</th>
<th scope="col" class="org-right">mean</th>
<th scope="col" class="org-right">median</th>
<th scope="col" class="org-right">uq</th>
<th scope="col" class="org-right">max</th>
<th scope="col" class="org-right">neval</th>
<th scope="col" class="org-left">cld</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">{     set.seed(12345)     sim = new("simple<sub>person</sub>")     for (i in 1:100) sim$run() }</td>
<td class="org-right">106.92</td>
<td class="org-right">107.73</td>
<td class="org-right">109.16</td>
<td class="org-right">108.31</td>
<td class="org-right">108.66</td>
<td class="org-right">114.07</td>
<td class="org-right">10.00</td>
<td class="org-left">b</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">{     set.seed(12345)     callSimplePersonB(100) }</td>
<td class="org-right">1.03</td>
<td class="org-right">1.09</td>
<td class="org-right">1.20</td>
<td class="org-right">1.13</td>
<td class="org-right">1.26</td>
<td class="org-right">1.66</td>
<td class="org-right">10.00</td>
<td class="org-left">a</td>
</tr>
</tbody>
</table>
</div>
</div>



<div id="outline-container-org846146a" class="outline-3">
<h3 id="org846146a"><span class="section-number-3">4.4</span> C++ using an EventReport</h3>
<div class="outline-text-3" id="text-4-4">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #008b8b;">library</span>(microsimulation)
sourceCpp(code = <span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">// [[Rcpp::depends(microsimulation)]]</span>
<span style="color: #8b2252;">#include &lt;microsimulation.h&gt;</span>
<span style="color: #8b2252;">enum state_t {Healthy,Cancer};</span>
<span style="color: #8b2252;">enum event_t {toOtherDeath, toCancer, toCancerDeath};</span>
<span style="color: #8b2252;">using Report = ssim::EventReport&lt;short,short,double&gt;;</span>
<span style="color: #8b2252;">class SimplePerson : public ssim::cProcess</span>
<span style="color: #8b2252;">{</span>
<span style="color: #8b2252;">public:</span>
<span style="color: #8b2252;">  state_t state;</span>
<span style="color: #8b2252;">  Report report;</span>
<span style="color: #8b2252;">  SimplePerson() { }</span>
<span style="color: #8b2252;">  void handleMessage(const ssim::cMessage*);</span>
<span style="color: #8b2252;">  void init();</span>
<span style="color: #8b2252;">};</span>
<span style="color: #8b2252;">/**</span>
<span style="color: #8b2252;">    Initialise a simulation run for an individual</span>
<span style="color: #8b2252;">*/</span>
<span style="color: #8b2252;">void SimplePerson::init() {</span>
<span style="color: #8b2252;">  state = Healthy;</span>
<span style="color: #8b2252;">  double tm = R::rweibull(8.0,85.0);</span>
<span style="color: #8b2252;">  this-&gt;scheduleAt(tm,toOtherDeath);</span>
<span style="color: #8b2252;">  this-&gt;scheduleAt(R::rweibull(3.0,90.0),toCancer);</span>
<span style="color: #8b2252;">}</span>
<span style="color: #8b2252;">/**</span>
<span style="color: #8b2252;">    Handle receiving self-messages</span>
<span style="color: #8b2252;">*/</span>
<span style="color: #8b2252;">void SimplePerson::handleMessage(const ssim::cMessage* msg) {</span>
<span style="color: #8b2252;">  report.add(state,msg-&gt;kind,previous(),ssim::now());</span>
<span style="color: #8b2252;">  switch(msg-&gt;kind) {</span>
<span style="color: #8b2252;">  case toOtherDeath:</span>
<span style="color: #8b2252;">  case toCancerDeath:</span>
<span style="color: #8b2252;">    ssim::Sim::stop_process();</span>
<span style="color: #8b2252;">    break;</span>
<span style="color: #8b2252;">  case toCancer:</span>
<span style="color: #8b2252;">    state = Cancer;</span>
<span style="color: #8b2252;">    if (R::runif(0.0,1.0) &lt; 0.5)</span>
<span style="color: #8b2252;">      this-&gt;scheduleAt(ssim::now() + R::rweibull(2.0,10.0), toCancerDeath);</span>
<span style="color: #8b2252;">    break;</span>
<span style="color: #8b2252;">  default:</span>
<span style="color: #8b2252;">    REprintf(\"No valid kind of event\\n\");</span>
<span style="color: #8b2252;">    break;</span>
<span style="color: #8b2252;">  } // switch</span>
<span style="color: #8b2252;">} // handleMessage()</span>
<span style="color: #8b2252;">// [[Rcpp::export]]</span>
<span style="color: #8b2252;">SEXP callSimplePersonC(int n = 10000) {</span>
<span style="color: #8b2252;">  SimplePerson person;</span>
<span style="color: #8b2252;">  for (int i = 0; i &lt; n; i++) {</span>
<span style="color: #8b2252;">    ssim::Sim::create_process(&amp;person);</span>
<span style="color: #8b2252;">    ssim::Sim::run_simulation();</span>
<span style="color: #8b2252;">    ssim::Sim::clear();</span>
<span style="color: #8b2252;">  }</span>
<span style="color: #8b2252;">  return person.report.wrap();</span>
<span style="color: #8b2252;">}</span>
<span style="color: #8b2252;">"</span>)
make_factor = <span style="color: #a020f0;">function</span>(x, labels)
    factor(as.integer(x)+1L,labels=labels)
set.seed(12345)
report = callSimplePersonC()
rates = with(report, merge(pt,events,all.x=<span style="color: #228b22;">TRUE</span>)) |&gt;
    transform(rate=ifelse(is.na(number),0,number)/pt,
              Key=make_factor(Key,c(<span style="color: #8b2252;">"Healthy"</span>,<span style="color: #8b2252;">"Cancer"</span>)),
              event=make_factor(event,c(<span style="color: #8b2252;">"toOtherDeath"</span>, <span style="color: #8b2252;">"toCancer"</span>, <span style="color: #8b2252;">"toCancerDeath"</span>)))
lattice::xyplot(rate~age|Key+event, data=rates, type=<span style="color: #8b2252;">"l"</span>)
</pre>
</div>


<div class="figure">
<p><img src="rates.png" alt="rates.png" />
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Mark Clements</p>
<p class="date">Created: 2023-03-08 Wed 10:42</p>
</div>
</body>
</html>

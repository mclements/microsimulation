% Rekapitulering av vad vi gjorde

\section{Overview of the changes to the code}

The computation can be modelled using the map-reduce paradigm. First,
we analysed the code, took out some parts and made some tests. The
conclusion was to first try to parallelise using openmp, then expand
to MPI.

%  2014-10-09
%    omp parallel shared(â¦) private(â¦) and
%    omp critical for update of the shared report instance.
First, to the map step of the code, we added
\lstset{language=C}
\begin{lstlisting}
#pragma omp parallel shared(nthreads,chunk) private(i,tid,sim,diffTime,cumTime)
...
#pragma omp for schedule(static,1).
\end{lstlisting}
However, the reduce step was not straight forward to parallelise. In
the serial version of the code, an associative array with scope
throughout the whole module (\emph{source file}) was used, and every
result was incrementally added to the end result. In this reduction
step several functions call was made updating the object, where the
functions accessed it in the scope of the file and not by a passed
reference. So in the first version, we just added
\lstset{language=C++}
\begin{lstlisting}
#pragma omp critical
  {
  // updating the result, i.e., ``reduction step''
    report.add(FullState(state, ext_grade,
               dx, psa>=3.0, cohort), msg->kind,
               previousEventTime, now());
  }
\end{lstlisting}
around the section accessing the resource.

After some performance analysis, we realised that the reduction step
as implemented became the bottle-neck of the whole software. We then
realised that it was possible to let each thread/process build up its
contribution to the resulting associative array in a private variable,
and then merge these partial results into the shared result instance.

The R software also have a feature of using multi-cores, and we used
that one as a benchmark what we should at least obtain

Summarising the steps, we call them
\begin{enumerate}
\item naive OpenMP (paralleising the map step)
\item improved OpenMP (first a thread-wise partial reduction, then
  reducing these partial results)
\item R automatic multi-threading.
\end{enumerate}

% R parallelisation

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "report"
%%% End:
